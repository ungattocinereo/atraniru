---
import Layout from '../layouts/Layout.astro';

const apartments = [
  {
    id: 'casa-carina',
    number: 'APT—01',
    title: 'Casa Carina',
    description: 'Светлые апартаменты в самом центре с панорамным видом на море. Просторная гостиная, полностью оборудованная кухня и терраса.',
    guests: 4,
    beds: 2,
    image: '/apartments/casa-carina.jpeg.avif',
  },
  {
    id: 'awesome-view',
    number: 'APT—02',
    title: 'Apartments with an awesome view',
    description: 'Панорамный вид на побережье из каждого окна. Современный интерьер с уютной атмосферой средиземноморского дома.',
    guests: 4,
    beds: 2,
    image: '/apartments/3-view-from-cristall-Pont.jpg',
  },
  {
    id: 'harmony-suite',
    number: 'APT—03',
    title: 'Harmony Suite',
    description: 'Элегантный люкс для пар. Продуманный дизайн, комфортная кровать и романтичная атмосфера в сердце Атрани.',
    guests: 2,
    beds: 1,
    image: '/apartments/harmony.jpg.avif',
  },
  {
    id: 'royal-suite',
    number: 'APT—04',
    title: 'Royal Suite',
    description: 'Премиальные апартаменты с захватывающим видом. Просторная планировка, стильный интерьер и полное оснащение.',
    guests: 4,
    beds: 2,
    image: '/apartments/royal.jpeg.avif',
  },
  {
    id: 'vintage-room',
    number: 'RM—05',
    title: 'Vintage Room',
    description: 'Комната в историческом стиле с подлинными деталями интерьера. Идеально для ценителей аутентичности.',
    guests: 2,
    beds: 1,
    image: '/apartments/room-in-atrani-vintage.webp',
  },
  {
    id: 'central-room',
    number: 'RM—06',
    title: 'Central Room',
    description: 'Комфортная комната в самом центре, рядом с мишленовским рестораном и пляжем.',
    guests: 2,
    beds: 1,
    image: '/apartments/2room-in-atrani-in-center.webp',
  },
  {
    id: 'orange-room',
    number: 'RM—07',
    title: 'Orange Room',
    description: 'Яркая комната с солнечным настроением. Продуманный минимализм и всё необходимое для комфорта.',
    guests: 2,
    beds: 1,
    image: '/apartments/orange-room.jpg',
  },
  {
    id: 'solo-room',
    number: 'RM—08',
    title: 'Solo Room',
    description: 'Идеально для соло-путешественников — продуманный минимализм и уютная атмосфера.',
    guests: 1,
    beds: 1,
    image: '/apartments/romfor-1-person.jpg.webp',
  },
  {
    id: 'bunkbed-room',
    number: 'RM—09',
    title: 'Bunkbed Room',
    description: 'Двухъярусная кровать и компактное пространство — отличный вариант для друзей или бюджетного отдыха.',
    guests: 2,
    beds: 2,
    image: '/apartments/casa-bunkbed-room.jpg',
  },
  {
    id: 'villa-ravello',
    number: 'APT—10',
    title: 'Villa In Ravello',
    description: 'Роскошная вилла в Равелло с потрясающим видом на горы и море. Идеальное уединение для особого отдыха.',
    guests: 6,
    beds: 3,
    image: '/apartments/villa-ravello-amalfiday-rent-1500x770.webp',
  },
];
---

<Layout
  title="Апартаменты — Atrani.ru"
  description="Апартаменты и комнаты на Амальфитанском побережье. Проверьте доступность и забронируйте жильё в Атрани и Равелло."
>
  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-bg-text" aria-hidden="true">ATRANI</div>

    <div class="hero-bg-image">
      <img src="/apartments/aria-di-mare-for-amalfi-day-2.webp" alt="" loading="eager" />
    </div>
    <div class="hero-overlay"></div>

    <div class="hero-content">
      <p class="hero-label">Размещение на побережье</p>
      <h1>
        <span class="highlight">НАШИ</span>
        АПАРТА&shy;МЕНТЫ
      </h1>
      <p class="hero-subtitle">
        От уютных комнат до роскошных вилл — выберите идеальное жильё на Амальфитанском побережье
      </p>
      <div class="hero-actions">
        <a href="#apartments-list" class="btn btn-white">Смотреть все</a>
        <a href="/contacts" class="btn btn-outline" style="border-color: white; color: white;">Связаться с нами</a>
      </div>
    </div>

    <div class="scroll-indicator">Scroll</div>
  </section>

  <!-- Stats -->
  <section class="stats">
    <div class="stats-grid reveal">
      <div class="stat-item">
        <div class="stat-number">10</div>
        <div class="stat-label">апартаментов</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">2</div>
        <div class="stat-label">города</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">500+</div>
        <div class="stat-label">довольных гостей</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">15+</div>
        <div class="stat-label">лет опыта</div>
      </div>
    </div>
  </section>

  <!-- Apartments List -->
  <section id="apartments-list" class="apartments-section">
    <div class="section-header reveal">
      <p class="section-label">01 — Размещение</p>
      <h2 class="section-title">Выберите ваш дом<br>на побережье</h2>
    </div>

    <div class="apartments-list">
      {apartments.map((apt, index) => (
        <article class="apt-card reveal" id={`apt-${apt.id}`}>
          <div class="apt-card-image">
            <img src={apt.image} alt={apt.title} loading="lazy" />
            <span class="apt-card-number">{apt.number}</span>
          </div>
          <div class="apt-card-body">
            <div class="apt-card-info">
              <h3 class="apt-card-title">{apt.title}</h3>
              <p class="apt-card-desc">{apt.description}</p>
              <div class="apt-card-meta">
                <span class="apt-meta-item">
                  <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                  {apt.guests} {apt.guests === 1 ? 'гость' : apt.guests < 5 ? 'гостя' : 'гостей'}
                </span>
                <span class="apt-meta-item">
                  <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V5H1v15h2v-3h18v3h2v-9c0-2.21-1.79-4-4-4z"/></svg>
                  {apt.beds} {apt.beds === 1 ? 'кровать' : 'кровати'}
                </span>
              </div>
            </div>
            <div class="apt-calendar-wrapper">
              <div class="apt-calendar-header">
                <p class="calendar-label">Календарь занятости</p>
              </div>
              <div class="apt-calendar" data-apartment-id={apt.id}>
                <div class="calendar-loading">Загрузка...</div>
              </div>
              <div class="calendar-legend">
                <span class="legend-item legend-available">
                  <span class="legend-dot"></span> Свободно
                </span>
                <span class="legend-item legend-booked">
                  <span class="legend-dot"></span> Занято
                </span>
                <span class="legend-item legend-today">
                  <span class="legend-dot"></span> Сегодня
                </span>
              </div>
            </div>
          </div>
        </article>
      ))}
    </div>
  </section>

  <!-- CTA -->
  <section class="cta">
    <div class="cta-bg-text" aria-hidden="true">BOOK</div>
    <div class="cta-content reveal">
      <h2 class="section-title">Готовы к отдыху?</h2>
      <p>Напишите нам — мы поможем выбрать идеальное жильё и организуем ваш отдых от А до Я.</p>
      <div class="cta-actions">
        <a href="/contacts" class="btn btn-white">Связаться с нами</a>
        <a href="https://wa.me/393270972329" class="btn btn-outline" style="border-color: white; color: white;" target="_blank" rel="noopener">WhatsApp</a>
      </div>
    </div>
  </section>
</Layout>

<style>
  /* Apartments Page Styles */

  /* Hero overrides */
  .hero {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
    background: var(--color-navy-deep);
    color: white;
    overflow: hidden;
    padding: 120px 40px 80px;
  }

  .hero-bg-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: var(--font-display);
    font-size: clamp(150px, 25vw, 400px);
    font-weight: 900;
    color: rgba(255, 255, 255, 0.03);
    pointer-events: none;
    white-space: nowrap;
    user-select: none;
    z-index: 2;
  }

  .hero-content {
    position: relative;
    z-index: 3;
    max-width: 1400px;
    margin: 0 auto;
    width: 100%;
  }

  .hero-label {
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 3px;
    color: var(--color-gray);
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    opacity: 0;
    animation: fadeInUp 0.8s var(--ease-out) 0.2s forwards;
  }

  .hero-label::before {
    content: '';
    width: 40px;
    height: 2px;
    background: var(--color-orange);
    margin-right: 16px;
  }

  .hero h1 {
    font-family: var(--font-display);
    font-size: clamp(48px, 10vw, 140px);
    font-weight: 900;
    line-height: 0.9;
    letter-spacing: -4px;
    margin-bottom: 32px;
    opacity: 0;
    animation: fadeInUp 0.8s var(--ease-out) 0.3s forwards;
  }

  .hero h1 .highlight {
    display: block;
    color: var(--color-orange);
  }

  .hero-subtitle {
    font-size: clamp(18px, 2vw, 24px);
    color: var(--color-gray);
    max-width: 600px;
    margin-bottom: 40px;
    opacity: 0;
    animation: fadeInUp 0.8s var(--ease-out) 0.4s forwards;
  }

  .hero-actions {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    opacity: 0;
    animation: fadeInUp 0.8s var(--ease-out) 0.5s forwards;
  }

  .scroll-indicator {
    position: absolute;
    bottom: 40px;
    left: 40px;
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--color-gray);
    z-index: 3;
  }

  .scroll-indicator::after {
    content: '';
    width: 60px;
    height: 1px;
    background: var(--color-gray);
  }

  @media (max-width: 768px) {
    .hero {
      padding: 100px 20px 60px;
    }

    .scroll-indicator {
      left: 20px;
    }
  }

  /* Apartments Section */
  .apartments-section {
    padding: 120px 40px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .apartments-list {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  /* Apartment Card */
  .apt-card {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    background: white;
    overflow: hidden;
    border: 2px solid transparent;
    transition: all 0.4s var(--ease-out);
  }

  .apt-card:nth-child(even) {
    direction: rtl;
  }

  .apt-card:nth-child(even) > * {
    direction: ltr;
  }

  .apt-card:hover {
    border-color: var(--color-orange);
  }

  /* Card Image */
  .apt-card-image {
    position: relative;
    aspect-ratio: 16/10;
    overflow: hidden;
  }

  .apt-card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: grayscale(40%);
    transition: all 0.5s var(--ease-out);
  }

  .apt-card:hover .apt-card-image img {
    filter: grayscale(0%);
    transform: scale(1.03);
  }

  .apt-card-number {
    position: absolute;
    top: 24px;
    left: 24px;
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 700;
    color: white;
    background: var(--color-navy-deep);
    padding: 6px 12px;
    letter-spacing: 2px;
  }

  /* Card Body */
  .apt-card-body {
    padding: 48px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 32px;
  }

  .apt-card-title {
    font-family: var(--font-display);
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -1px;
    color: var(--color-navy);
    margin-bottom: 16px;
  }

  .apt-card-desc {
    font-size: 16px;
    line-height: 1.6;
    color: var(--color-gray-dark);
    margin-bottom: 16px;
  }

  .apt-card-meta {
    display: flex;
    gap: 24px;
  }

  .apt-meta-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--color-gray);
  }

  .apt-meta-item svg {
    width: 16px;
    height: 16px;
    color: var(--color-orange);
  }

  /* Calendar Wrapper - compact */
  .apt-calendar-wrapper {
    background: var(--color-bg-light);
    padding: 16px;
    border-left: 3px solid var(--color-orange);
  }

  .apt-calendar-header {
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .calendar-label {
    font-family: var(--font-display);
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--color-orange);
  }

  .apt-calendar {
    min-height: 80px;
  }

  .calendar-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 80px;
    font-size: 12px;
    color: var(--color-gray);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .calendar-legend {
    display: flex;
    gap: 12px;
    margin-top: 10px;
    flex-wrap: wrap;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-gray-dark);
  }

  .legend-dot {
    width: 8px;
    height: 8px;
    display: block;
  }

  .legend-available .legend-dot {
    background: white;
    border: 1px solid var(--color-gray-light);
  }

  .legend-booked .legend-dot {
    background: var(--color-navy);
  }

  .legend-today .legend-dot {
    background: var(--color-navy-deep);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .apt-card {
      grid-template-columns: 1fr;
    }

    .apt-card:nth-child(even) {
      direction: ltr;
    }

    .apt-card-image {
      aspect-ratio: 16/9;
    }
  }

  @media (max-width: 768px) {
    .apartments-section {
      padding: 80px 20px;
    }

    .apt-card-body {
      padding: 24px;
    }

    .apt-card-title {
      font-size: 22px;
    }

    .apt-card-meta {
      flex-wrap: wrap;
      gap: 12px;
    }

    .apt-calendar-wrapper {
      padding: 12px;
    }

    .apt-card:hover {
      border-color: transparent;
    }
  }

  /* Animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<style is:global>
  /* ==========================================================================
     Calendar Styles (global — these elements are generated by JavaScript)
     ========================================================================== */

  /* Two-column month layout */
  .apt-calendar .calendar-months-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .apt-calendar .calendar-month-title {
    font-family: var(--font-display);
    font-size: 11px;
    font-weight: 700;
    color: var(--color-navy);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .apt-calendar .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
  }

  .apt-calendar .calendar-weekday {
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-gray);
    text-align: center;
    padding: 2px 0;
  }

  .apt-calendar .calendar-day {
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-body);
    font-size: 11px;
    font-weight: 500;
    color: var(--color-navy);
    background: white;
    padding: 4px 0;
    transition: background 0.15s;
  }

  .apt-calendar .calendar-day.empty {
    background: transparent;
  }

  .apt-calendar .calendar-day.past {
    color: var(--color-gray-light);
    background: transparent;
  }

  .apt-calendar .calendar-day.today {
    background: var(--color-navy-deep);
    color: white;
    font-weight: 700;
  }

  .apt-calendar .calendar-day.booked {
    background: var(--color-navy);
    color: var(--color-gray);
    text-decoration: line-through;
    font-weight: 600;
  }

  .apt-calendar .calendar-day.available {
    background: white;
    color: var(--color-navy);
  }

  .apt-calendar .calendar-day.available:hover {
    background: var(--color-orange);
    color: white;
  }

  /* Calendar Navigation (JS-generated) */
  .apt-calendar .calendar-nav {
    display: flex;
    gap: 4px;
  }

  .apt-calendar .calendar-nav-btn {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: 1px solid var(--color-navy);
    color: var(--color-navy);
    cursor: pointer;
    transition: all 0.3s var(--ease-out);
    padding: 0;
  }

  .apt-calendar .calendar-nav-btn:hover {
    background: var(--color-navy);
    color: white;
  }

  .apt-calendar .calendar-nav-btn svg {
    width: 12px;
    height: 12px;
  }

  .apt-calendar .apt-calendar-header {
    margin-bottom: 8px;
    display: flex;
    justify-content: flex-end;
    align-items: center;
  }

  @media (max-width: 768px) {
    .apt-calendar .calendar-months-grid {
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .apt-calendar .calendar-day {
      font-size: 10px;
      padding: 3px 0;
    }
  }
</style>

<script>
  // Availability Calendar Script
  const MONTHS_RU = [
    'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
    'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
  ];

  const WEEKDAYS_RU = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];

  const MONTHS_TO_SHOW = 2;

  interface AvailabilityData {
    generated: string;
    apartments: Record<string, {
      name: string;
      bookedDates: string[];
      feedsFailed: number;
      totalFeeds: number;
      eventsCount: number;
    }>;
  }

  function formatDateKey(year: number, month: number, day: number): string {
    return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  }

  function renderCalendar(
    container: HTMLElement,
    bookedDates: Set<string>,
    startMonthOffset: number
  ) {
    const today = new Date();
    const todayStr = formatDateKey(today.getFullYear(), today.getMonth(), today.getDate());

    let html = '';

    // Navigation buttons
    html += `<div class="apt-calendar-header" style="margin-bottom: 0;">`;
    html += `<div class="calendar-nav">`;
    html += `<button class="calendar-nav-btn" data-dir="prev" aria-label="Назад">`;
    html += `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>`;
    html += `</button>`;
    html += `<button class="calendar-nav-btn" data-dir="next" aria-label="Вперёд">`;
    html += `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>`;
    html += `</button>`;
    html += `</div>`;
    html += `</div>`;

    html += `<div class="calendar-months-grid">`;
    for (let i = 0; i < MONTHS_TO_SHOW; i++) {
      const date = new Date(today.getFullYear(), today.getMonth() + startMonthOffset + i, 1);
      const year = date.getFullYear();
      const month = date.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      // Monday=0 based first day offset
      let firstDayOfWeek = date.getDay() - 1;
      if (firstDayOfWeek < 0) firstDayOfWeek = 6;

      html += `<div class="calendar-month">`;
      html += `<div class="calendar-month-title">${MONTHS_RU[month]} ${year}</div>`;
      html += `<div class="calendar-grid">`;

      // Weekday headers
      for (const wd of WEEKDAYS_RU) {
        html += `<div class="calendar-weekday">${wd}</div>`;
      }

      // Empty cells before first day
      for (let e = 0; e < firstDayOfWeek; e++) {
        html += `<div class="calendar-day empty"></div>`;
      }

      // Days
      for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = formatDateKey(year, month, d);
        const isToday = dateStr === todayStr;
        const isPast = new Date(Date.UTC(year, month, d)) < new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));
        const isBooked = bookedDates.has(dateStr);

        let cls = 'calendar-day';
        if (isToday) cls += ' today';
        else if (isPast) cls += ' past';
        else if (isBooked) cls += ' booked';
        else cls += ' available';

        html += `<div class="${cls}">${d}</div>`;
      }

      html += `</div></div>`;
    }
    html += `</div>`; // close calendar-months-grid

    container.innerHTML = html;

    // Attach navigation event listeners
    container.querySelectorAll('.calendar-nav-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const dir = (btn as HTMLElement).dataset.dir;
        const newOffset = dir === 'next' ? startMonthOffset + MONTHS_TO_SHOW : startMonthOffset - MONTHS_TO_SHOW;
        // Don't go before current month
        if (newOffset < 0) return;
        renderCalendar(container, bookedDates, newOffset);
      });
    });
  }

  // Load availability data and render calendars
  async function initCalendars() {
    try {
      const response = await fetch('/data/availability.json');
      if (!response.ok) throw new Error('Failed to load availability data');

      const data: AvailabilityData = await response.json();

      document.querySelectorAll<HTMLElement>('.apt-calendar').forEach(container => {
        const aptId = container.dataset.apartmentId;
        if (!aptId) return;

        const aptData = data.apartments[aptId];
        const bookedDates = new Set<string>(aptData?.bookedDates || []);

        renderCalendar(container, bookedDates, 0);
      });
    } catch (err) {
      console.error('Failed to load availability:', err);
      document.querySelectorAll('.calendar-loading').forEach(el => {
        el.textContent = 'Не удалось загрузить данные';
      });
    }
  }

  // Run when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCalendars);
  } else {
    initCalendars();
  }
</script>
